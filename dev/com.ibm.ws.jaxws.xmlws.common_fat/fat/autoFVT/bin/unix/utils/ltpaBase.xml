<?xml version="1.0"?>                     
<!DOCTYPE project [
        <!ENTITY instance              SYSTEM "file:../../../instance.xml">
        <!ENTITY properties            SYSTEM "file:../../../src/xmls/properties.xml">
        <!ENTITY taskdefs              SYSTEM "file:../../../src/xmls/taskdefs.xml">
        <!ENTITY taskdefs_post_compile SYSTEM "file:../../../src/xmls/taskdefs_post_compile.xml">
        <!ENTITY path_refs             SYSTEM "file:../../../src/xmls/path_refs.xml">
        <!ENTITY targets               SYSTEM "file:../../../src/xmls/targets.xml">
]>

<!--

  1.1, 1/4/08
   Description:  
      1) start the server 
      2) run wsadmin.sh with 
          LTPA_LDAPSecurityOn chiawang.austin.ibm.com testuser testuserpwd 389 austin.ibm.com
      3) stop server
      4) run handleLTPAMisc to handle:
         a) <FVT_HOME>/src/xmls/properties.xml userid and password
         b) If zOS handle SAF, appEnabled
         c) handl sas.client.props, rmi.client.props and ipc.client.props
      5) if zos run wsc2n.sh -X

   Change History:
   Date        UserId        Feature/Defect    Description
   12/07/2007  gkuo                            create for WSFP Regression and WAS61x

-->

<project default="all" basedir=".">
  &instance;
  &properties;
   <property name="profile.dir" value="${WAS.base.dir}/profiles/AppSrv01"/>
   <property name="zos.profile.dir" value="${WAS.base.dir}/profiles/default"/>
  &path_refs;
  &taskdefs;
  &taskdefs_post_compile;
  &targets;
  <property name="LTPAHost"     value="chiawang.austin.ibm.com"/>
  <property name="LTPAPort"     value="389"/>
  <property name="LTPAUser"     value="testuser"/>
  <property name="LTPAPassword" value="testuserpwd"/>
  <property name="LTPADomain"   value="austin.ibm.com"/>

  <condition property="isZos">
      <os family="z/os"/>
  </condition>

  <path id="ltpataskclasspath">
    <pathelement location="${FVT.base.dir}/bin/unix/utils"/>
    <path refid="wastaskclasspath"/>
  </path>

  <taskdef name="handleLTPAMisc"
           classname="handleLTPAMisc">
     <classpath refid="ltpataskclasspath"/>
  </taskdef>


  <target name="all" depends="printEnv, start-server, ltpaWsadmin, enableSTS, stop-server, ltpamisc, wsc2nsh" />

  <target name="ltpaWsadmin">
     <echo message="run wsadmin to enable LTPA" />
     <exec executable="${profile}/bin/wsadmin${os.ext}">
        <arg value="-conntype" />
        <arg value="soap" />
        <arg value="-host" />
        <arg value="localhost" />
        <arg value="-port" />
        <arg value="${soap.connector.address}" />
        <arg value="-username" />
        <arg value="${security.user.name}" />
        <arg value="-password" />
        <arg value="${security.password}" />
        <arg value="-c" />
        <arg value="LTPA_LDAPSecurityOn ${LTPAHost} ${LTPAUser} ${LTPAPassword} ${LTPAPort} ${LTPADomain}" />
     </exec>
  </target>

  <target name="enableSTS">
     <echo message="run wsadmin to set up WSTrust STS config" />
     <exec executable="${profile}/bin/wsadmin${os.ext}">
        <arg value="-conntype" />
        <arg value="soap" />
        <arg value="-host" />
        <arg value="localhost" />
        <arg value="-port" />
        <arg value="${soap.connector.address}" />
        <arg value="-username" />
        <arg value="${security.user.name}" />
        <arg value="-password" />
        <arg value="${security.password}" />
        <arg value="-profile" />
        <arg value="${FVT.base}/autoFVT/src/wssecfvt/jython/Helper.py" />
        <arg value="-f" />
        <arg value="${FVT.base}/autoFVT/src/wssecfvt/wstrust/jython/WSTrustFvt.py" />
     </exec>
  </target>

  <target name="ltpamisc">
      <echo message="run javaClass handleLTPAMisc to handle properties" />
      <echo message="also change ${FVT.base.dir}/src/xmls/properties.xml userid and password" />
      <echo message="     update SAF and appEnabled if zos" />
      <handleLTPAMisc fvtBaseDir="${FVT.base.dir}"
                      curProfPath="${profile}"
                      ltpaHost="${LTPAHost}"     
                      ltpaPort="${LTPAPort}"     
                      ltpaUser="${LTPAUser}"     
                      ltpaPassword="${LTPAPassword}" 
                      ltpaDomain="${LTPADomain}"
                      soapPort="${soap.connector.address}" 
                      />
  </target>

  <target name="wsc2nsh" if="isZos">
     <echo message="run wsc2n.sh" />
     <exec executable="${WAS.base.dir}/bin/wsc2n.sh">
        <arg value="-X" />
     </exec>
  </target>

</project>
