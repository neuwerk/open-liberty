<?xml version="1.0" encoding="UTF-8"?>
<!--

   Description:  Test JAXWS 2.2 addressing tests
     
   Date        UserId      Defect          Description
   04/22/2010  btiffany                    new file
-->
<project basedir="." default="buildall" name="jaxws22_addressing">

	<property name="componentName" value="jaxws22/addressing" />
	<property name="baseName" value="jaxws22" />
	

	<!-- use import instead of entity refs -->   
    <import file="../../xmls/common_imports.xml"/>

	<property name="srcdir" value="${FVT.base.dir}/src/${componentName}" />
	<property name="workdir" value="${FVT.build.work.dir}/${componentName}" />

<!-- This path id is used in the targets.xml file when running any of
       the component-run* targets.  This allows setting the classpath 
       for an individual test.
  -->
    <!-- the factory methods test requires the wsdl validator plugin to be on the classpath -->
    <!-- not a likely customer scenario, but dev. wanted this code path covered -->
	<path id="componentClasspath">
        <path refid="thinclientclasspath"/>  
	</path>
    
   <target name="printcp" >  <!-- print the classpath for debugging --> 
      <property name="classpathasprop" refid="componentClasspath"/>
      <echo message="componentClasspath is ${classpathasprop}" />
    </target>

	<target name="buildall" depends="clean, init, server, client, managedclient, test" />

	<target name="init" depends="setenv">
		<echo message="${test.name} Initializing..." />
		<antcall target="component-init" />
		
		<mkdir dir="${workdir}"/>
		<mkdir dir="${FVT.build.classes.dir}/${componentName}"/>
	</target>

	<target name="clean">
		<echo message="${test.name} Cleaning..." />
		<delete dir="${FVT.build.classes.dir}/${componentName}"/>
		<delete dir="${workdir}"/>
	</target>
	
	<!-- Build server artifacts -->
	<target name="server" depends="setenv">
	    <!-- for each folder, call subserver to build the ear -->
    	<property name="server.work.dir" value="${FVT.build.work.dir}/${componentName}/server" />
    	<property name="server.src.dir" value="${FVT.base.dir}/src/${componentName}/server" />
		<antcall target="subserver">
	           <param name="folder" value="annoOffDDOn"/>
	        </antcall>		
	        
		<antcall target="subserver">
	           <param name="folder" value="annoOnDDOff"/>
	        </antcall>		
		<antcall target="subserver">
	           <param name="folder" value="noAnnoDDOn"/>
	      </antcall>		
		<antcall target="subserver">
	           <param name="folder" value="annoOnNoDD"/>
	      </antcall>	
  		<antcall target="subserver">
	           <param name="folder" value="annoOnImplicitDDOff"/>
	     </antcall>			      	      		      

	</target>
	
	
	<!-- called by server for each ear --> 
	<target name="subserver" depends="setenv">  <!-- paramaters: folder -->
	    <echo message="Processing folder: ${folder} "/>
	    <delete dir="${server.work.dir}/${folder}"/>
	    <mkdir dir="${server.work.dir}/${folder}"/>
	    <!-- compile the impl and jaxws beans -->
	    <javac compiler="modern" srcdir="${server.src.dir}/${folder}" fork="true"
			   destdir="${server.work.dir}/${folder}"
			   includes="*java"
			   deprecation="${deprecation}"
			   debug="${debug}"
			   source="${build.tests.with.java.level}"
			   target="${build.tests.with.java.level}"
               failonerror="${failonerror}">
			<classpath>
				<path refid="classpath" />
			</classpath>
            <compilerarg value="-J-Xbootclasspath/p:${ref.to.22api}"/>
		</javac>
	   	<javac compiler="modern" srcdir="${server.src.dir}/common" fork="true"
			   destdir="${server.work.dir}/${folder}"
			   includes="**/*java"
			   deprecation="${deprecation}"
			   debug="${debug}"
	   		   source="${build.tests.with.java.level}"
	   		   target="${build.tests.with.java.level}"
               failonerror="${failonerror}">
			<classpath>
				<path refid="classpath" />
			</classpath>
            <compilerarg value="-J-Xbootclasspath/p:${ref.to.22api}"/>
		</javac>
		
		<mkdir dir="${FVT.build.lib.dir}/${componentName}" />
	    <delete file="${FVT.build.lib.dir}/${componentName}/${folder}.jar" />

     	<jar destfile="${FVT.build.lib.dir}/${componentName}/${folder}.jar">
			
			<!--
			<zipfileset dir="${server.src.dir}/common"
				includes="*.xsd"
				prefix="WEB-INF/wsdl" />
		    
			<zipfileset dir="${server.src.dir}/${folder}"
				includes="*.wsdl, *.xsd"
				prefix="META-INF/wsdl" />	
			-->	
				
            <zipfileset dir="${server.src.dir}/${folder}" prefix="META-INF/">
                <include name="ejb-jar.xml" />
                <include name="webservices.xml" />
            </zipfileset>
			
			<zipfileset dir="${server.src.dir}/${folder}"
				includes="**/*.java"
				prefix="META-INF/src" />
				
			<fileset dir="${server.work.dir}/${folder}">			
				<include name="**/*.class" />			
			</fileset>
		</jar>
		
		<delete file="${FVT.build.installableApps.dir}/jaxws22addr_${folder}.ear"/>
		<ear earfile="${FVT.build.installableApps.dir}/jaxws22addr_${folder}.ear"
		     appxml="${FVT.base.dir}/src/jaxws22/addressing/server/${folder}/application.xml">
			<fileset dir="${FVT.build.lib.dir}/${componentName}" includes="${folder}.jar" />		
		</ear>	
        <!--<endpointenable earfile="${FVT.build.installableApps.dir}/jaxws22addr_${folder}.ear" />-->
	</target>  <!-- end subserver --> 

	<target name="client" >	
	   <!-- gen the classes needed to run the FactoryMethods test -->
		<wsimport debug="${debug}" fork="true"
				 verbose="true"
			      keep="true"
			      destdir="${FVT.build.classes.dir}"			    
			      wsdl="${srcdir}/client/wsdl/EchoService.wsdl">
            <jvmarg line="-Djava.endorsed.dirs=${FVT.base.dir}/common/jars/endorsed"/>
		 </wsimport>	
 	   	<javac compiler="modern" srcdir="${srcdir}/client" fork="true"
			   destdir="${FVT.build.classes.dir}"
			   includes="**/*java"
			   deprecation="${deprecation}"
			   debug="${debug}"
			   source="${build.tests.with.java.level}"
			   target="${build.tests.with.java.level}"
               failonerror="${failonerror}">
			<classpath>
				<path refid="classpath" />
			</classpath>
            <compilerarg value="-J-Xbootclasspath/p:${ref.to.22api}"/>
		</javac>   
	</target>
	
	<target name="managedclient" depends="setenv, client">  
       <delete file= "${FVT.build.lib.dir}/jaxws22addrclient.jar" />
	   <jar destfile="${FVT.build.lib.dir}/jaxws22addrclient.jar"
	        manifest="${FVT.base.dir}/src/jaxws22/addressing/client/MANIFEST.MF"
	    >
		  <fileset dir="${FVT.build.classes.dir}">
	        <include name="jaxws22/addressing/server/*.class"/>	
	        <include name="jaxws22/addressing/client/*.class"/>	
	      </fileset>  
	        
         <!-- pick up application-client.xml and manifest.mf -->
         <zipfileset dir="${FVT.base.dir}/src/jaxws22/addressing/client"
            prefix="META-INF">          	
           <exclude name="**/application.xml" />
           <exclude name="**/*.java" />
         </zipfileset> 
         
         <zipfileset dir="${FVT.base.dir}/src/jaxws22/addressing/client/wsdl"
            prefix="META-INF/wsdl">          	
           <exclude name="**/*Required*" />

         </zipfileset> 
      </jar>    
      
      <delete file="${FVT.build.installableApps.dir}/jaxws22addrclient.ear" />
      <ear earfile="${FVT.build.installableApps.dir}/jaxws22addrclient.ear"       
         appxml="${FVT.base.dir}/src/jaxws22/addressing/client/application.xml">	
	      <fileset dir="${FVT.build.lib.dir}" includes="jaxws22addrclient.jar"/>
      </ear>
   </target>
	

	
	<!-- Build test artifacts -->
	<target name="test" depends="setenv" >
		<echo message="${test.name} building TestCases..." />
					      	
		<!-- compile test classes -->
		<javac compiler="modern" srcdir="${FVT.base.dir}/src/${componentName}"
			   destdir="${FVT.build.classes.dir}"
			   includes="**/test/**/*.java"
			   deprecation="${deprecation}"
			   debug="${debug}"
	           source="${build.tests.with.java.level}"
	           target="${build.tests.with.java.level}"
               failonerror="${failonerror}">
			<classpath>
				<path refid="classpath" />
			</classpath>
		</javac>	
		
	</target>
	

	<target name="preinstall" />
	
	<target name="install" depends="setenv">
		<ant antfile="${FVT.base.dir}/src/${componentName}/installTest.xml"
			 dir="${FVT.base.dir}/src/${componentName}">
			<property name="install.mode" value="${rt.install.mode}"/>
		</ant>
  </target>
  
  	<target name="singleinstall" depends="setenv">
		<ant antfile="${FVT.base.dir}/src/${componentName}/installTest.xml"
			 dir="${FVT.base.dir}/src/${componentName}"
             target="singleinstall">
			<property name="install.mode" value="${rt.install.mode}"/>
		</ant>
  </target>
  
   	<target name="singleuninstall" depends="setenv">
		<ant antfile="${FVT.base.dir}/src/${componentName}/uninstallTest.xml"
			 dir="${FVT.base.dir}/src/${componentName}"
             target="singleuninstall">
			<property name="install.mode" value="${rt.install.mode}"/>
		</ant>
  </target>
  
    
  <!-- The uninstall target will uninstall the server side piece of the test
       from WebSphere.  This target calls the uninstallTest.xml file for
       the test.
  -->           
  <target name="uninstall" depends="setenv">
    <ant antfile="${FVT.base.dir}/src/${componentName}/uninstallTest.xml"
         dir="${FVT.base.dir}/src/${componentName}">
      <property name="uninstall.mode" value="${rt.uninstall.mode}"/>
    </ant>
  </target>
</project>
