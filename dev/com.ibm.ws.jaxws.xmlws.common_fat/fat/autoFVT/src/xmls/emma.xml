<?xml version="1.0"?>                     

<!--
   1.6, 9/20/07
   
   Description:
   ================ 
       This is an Ant build file for use with the Emma code coverage tool.
                
       Properties necessary for running this build file:
                
       Property                     Value
       ================             =================  
       WAS.base.dir                 WebSphere Home
       source.path                  Top of source (both FVT and Dev source code)
       packages                     The packages to be instrumented                
       staf.dir                     The location of STAF
       min,percent                  The minimum percent to find when looking for low coverage methods   
     
                            
   Change History:
   ================
       Date        UserId         Feature/Defect          Description
       07/15/2006  ulbricht       375601                  New File
       09/18/2007  ulbricht       468109                  Fix cleanup target

-->

<project default="instrument" basedir=".">
     
     
  <!-- This is the path that defines where emma resides.
  -->                 
  <path id="emma.lib">
    <pathelement location="${source.path}/WFVT/ws/code/websvcs.fvt/common/jars/emma_ant.jar"/>
    <pathelement location="${source.path}/WFVT/ws/code/websvcs.fvt/common/jars/emma.jar"/>
  </path>
  
     
  <!-- This is the Ant task definition for emma.
  -->   
  <taskdef name="emma"
           classname="com.vladium.emma.emmaTask">
    <classpath refid="emma.lib"/>
  </taskdef>
  
     
  <!-- This target will try to find any stray .ec or .em files and delete them
       so that the code coverage report generated reflects the current run.
  -->   
  <target name="cleanup">
    <delete>
      <fileset dir="${WAS.base.dir}">
        <include name="**/*.em"/>
        <include name="**/*.ec"/>
      </fileset>
	  <fileset dir="${source.path}">
        <include name="**/*.em"/>
        <include name="**/*.ec"/>
      </fileset>
      <fileset dir="${staf.dir}">
        <include name="**/*.em"/>
        <include name="**/*.ec"/>
      </fileset>
	</delete>
  </target>
  
     
  <!-- This target will enable trace in many places so that the code coverage report will
       display maximum coverage.
  -->         
  <target name="enable.trace">
	<replace file="${source.path}/WFVT/ws/code/websvcs.fvt/src/xmls/properties.xml" token="property name=&quot;server.trace&quot; value=&quot;false&quot;" 
		     value="property name=&quot;server.trace&quot; value=&quot;true&quot;"/>
	<replace file="${source.path}/WFVT/ws/code/websvcs.fvt/src/xmls/properties.xml" token="property name=&quot;server.trace.package.name&quot; value=&quot;com.ibm.ws.webservices.*=all=enabled&quot;" 
		     value="property name=&quot;server.trace.package.name&quot; value=&quot;*=info:org.apache.axis2.*=all:com.ibm.ws.websvcs.*&quot;"/>
	<replace file="${source.path}/WFVT/ws/code/websvcs.fvt/src/build.xml" token="&lt;junit dir=&quot;${FVT.build.classes.dir}&quot; printsummary=&quot;yes&quot; haltonfailure=&quot;no&quot; fork=&quot;yes&quot; timeout=&quot;${test.timeout}&quot;&gt;"
		     value="&lt;junit dir=&quot;${FVT.build.classes.dir}&quot; printsummary=&quot;yes&quot; haltonfailure=&quot;no&quot; fork=&quot;yes&quot; timeout=&quot;${test.timeout}&quot;&gt;${line.separator}&lt;jvmarg value=&quot;-DtraceSettingsFile=TraceSettings.properties&quot;/&gt;${line.separator}&lt;jvmarg value=&quot;-Djava.util.logging.manager=com.ibm.ws.bootstrap.WsLogManager&quot;/&gt;${line.separator}&lt;jvmarg value=&quot;-Djava.util.logging.configureByServer=true&quot;/&gt;"/>
	<replace file="${source.path}/WFVT/ws/code/websvcs.fvt/src/xmls/path_refs.xml" token="&lt;pathelement location=&quot;${FVT.build.classes.dir}&quot;/&gt;"
		     value="&lt;pathelement location=&quot;${FVT.build.classes.dir}&quot;/&gt;${line.separator}&lt;pathelement location=&quot;${FVT.base.dir}/properties&quot;/&gt;"/>
	<replace file="${WAS.base.dir}/properties/TraceSettings.properties" token="com.ibm.ejs.ras.*=all=enabled" 
		     value="com.ibm.ws.websvcs.*=all=enabled:org.apache.axis2.*=all=enabled"/>
	<replace file="${WAS.base.dir}/profiles/AppSrv01/properties/wsadmin.properties" token="#com.ibm.ws.scripting.traceString=com.ibm.*=all=enabled"
		     value="com.ibm.ws.scripting.traceString=com.ibm.ws.websvcs.*=all=enabled:org.apache.axis2.*=all=enabled"/>
  </target>
	
  
  <!-- This target will instrument the class files so that the
       code coverage data can be collected.
  -->
  <target name="instrument" depends="cleanup, enable.trace">
  
    <emma>
      <instr merge="true" mode="overwrite">
        <instrpath>    
          <fileset dir="${WAS.base.dir}">
            <exclude name="plugins/ant.jar"/>
            <exclude name="plugins/com.ibm.ws.wccm_*.jar"/>
            <exclude name="plugins/com.ibm.ws.security.crypto_*.jar"/>
            <include name="plugins/**/*.jar"/>
            <include name="runtimes/**/*.jar"/>
          </fileset>
        </instrpath>
        <filter includes="${packages}"/>
        <!-- I'll exclude any rm related packages on purpose for now.
        -->
        <filter excludes="com.ibm.ws.websvcs.rm.*"/>
        <!-- This package is not owned by the Austin Web services team
             so I'll exclude it for now.
        -->
        <filter excludes="com.ibm.ws.websvcs.pmi.reqmetrics"/>
      </instr>
    </emma>
    
     
    <!-- The emma jars also need to be copied to WebSphere so
         that when WebSphere's running that it has access to the
         Emma class files.
    -->
    <copy todir="${WAS.base.dir}/lib" overwrite="yes">
      <fileset dir="${source.path}/WFVT/ws/code/websvcs.fvt/common/jars">
        <include name="emma_ant.jar"/>
      </fileset>
    </copy>
    <copy todir="${WAS.base.dir}/java/jre/lib/ext" overwrite="yes">
      <fileset dir="${source.path}/WFVT/ws/code/websvcs.fvt/common/jars">
        <include name="emma.jar"/>
      </fileset>
    </copy>
    
  </target>
  
  
  <!-- This target will generate the code coverage report.  The report
       will be located in the source.path directory with a name of
       coverage.html.
  -->    
  <target name="report">
  
    <emma>
      <report sourcepath="${source.path}" encoding="UTF-8">
        <fileset dir="${WAS.base.dir}">
          <include name="**/*.em"/>
          <include name="**/*.ec"/>
        </fileset>
        <fileset dir="${source.path}">
          <include name="**/*.em"/>
          <include name="**/*.ec"/>
        </fileset>
        <fileset dir="${staf.dir}">
          <include name="**/*.em"/>
          <include name="**/*.ec"/>
        </fileset>
        <txt outfile="${source.path}/coverage.txt"/>
        <html outfile="${source.path}/coverage.html"/>
        <xml outfile="${source.path}/coverage.xml"/>
      </report>
    </emma>
    
  </target>
  
     
  <!-- This target will allow the ability to find methods with low
       percentage of coverage.
  -->
  <target name="unused.methods">
    <javac compiler="modern" srcdir=".">
      <include name="FindUnusedMethods.java"/>
    </javac>
    <java classname="FindUnusedMethods">
      <arg value="${min.percent}"/>
    </java>
  </target>
  
</project>
