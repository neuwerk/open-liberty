<?xml version="1.0"?>
<project name="execute.websvcs.fvt" default="executeTests" basedir=".">
 
  <dirname property="fvttop" file="../../.."/>

  <!-- Load the bootstrapping.properties file. There are two non-standard
       properties required in bootstrapping.properties that are needed
       to execute the unittest script:
         localWASHome
         wasBuildNumber
       If executing this build file manually, those properties should be
       added to bootrapping.properties beforehand. When executing TestBuild.xml
       they will be added automatically.
       Also, ant should reside in common/jars/ant. When executing the
       TestBuild.xml, ANT is put there using what is provided by autoWAS.
   -->
  <property name="fvtBaseDir" value="${fvttop}/FVT/ws/code/websvcs.fvt"/>
  <property file="${fvtBaseDir}/bootstrapping.properties"/>
  <property name="washome" value="${localWASHome}"/>
  <property name="buildnumber" value="${wasBuildNumber}"/>
  <property name="anthome" value="${fvtBaseDir}/common/jars/ant"/>
  <property name="out.log" value="${fvtBaseDir}/out.log"/>
  <property name="out.log.final" value="${fvtBaseDir}/results/out.log"/>
  <property name="execution.complete.log" value="${fvtBaseDir}/executionComplete.log"/>

  <!-- User defined property file -->
  <condition property="test.bin" value="nt">
    <os family="windows"/>
  </condition>
  <condition property="test.bin" value="unix">
    <not>
      <os family="windows"/>
    </not>
  </condition>
  
  <condition property="test.extension" value="bat">
    <os family="windows"/>
  </condition>
  <condition property="test.extension" value="sh">
    <not>
      <os family="windows"/>
    </not>
  </condition>

  <property name="unittest" value="${fvtBaseDir}/bin/${test.bin}/unittest_redirect.${test.extension}"/>

  <target name="clean">
     <delete file="${out.log}"/>
     <delete file="${out.log.final}"/>
    <delete file="${execution.complete.log}"/>
  </target>

  <target name="printEnv">
    <echo message="washome: ${washome}"/>
    <echo message="buildnumber: ${buildnumber}"/>
    <echo message="anthome: ${anthome}"/>
    <echo message="fvttop: ${fvttop}"/>
    <echo message="fvtBaseDir: ${fvtBaseDir}"/>
    <echo message="out.log: ${out.log}"/>
    <echo message="out.log.final: ${out.log.final}"/>
    <echo message="execution.complete.log: ${execution.complete.log}"/>
  </target>

  <target name="executeTests" depends="clean, printEnv">
    <property name="groupingTarget" value="runFvt"/>
     
    <condition property="useShell" value="bin/bash">
      <equals arg1="${platformName}" arg2="sun"/>
    </condition>
    <condition property="useShell" value="bin/sh">
      <not>
        <equals arg1="${platformName}" arg2="sun"/>
      </not>
    </condition>

    <replace file="${unittest}"
             token="bin/sh"
             value="${useShell}"/>
    <chmod file="${unittest}" perm="777"/>

    <exec dir="${fvtBaseDir}" executable="${unittest}" failonerror="false" spawn="true"> 
      <arg value="${fvttop}"/> 
      <arg value="${washome}"/>
      <arg value="${buildnumber}"/> 
      <arg value="IBASE"/> 
      <arg value="${anthome}"/>
      <arg value="${groupingTarget}"/>
    </exec>
    <echo message="Output is being logged in ${out.log}"/>

    <echo message="Waiting a maximum of 2400 minutes. Check ${out.log} for test output."/>
    <waitfor maxwait="2400" maxwaitunit="minute" checkevery="1">
      <available file="${execution.complete.log}"/>
    </waitfor>  
  </target>

</project>
